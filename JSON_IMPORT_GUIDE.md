# 📝 JSON 数据导入指南

本指南说明如何将 `memory.json` 中的备忘录数据导入到 `memos_dev.db` 数据库中。

## 🎯 功能特点

- ✅ 自动检测内容重复，跳过已存在的备忘录
- ✅ 保留原始时间戳（创建时间和更新时间）
- ✅ 保留所有属性（标签、置顶、归档、可见性等）
- ✅ 自动提取和创建标签
- ✅ 使用事务优化性能
- ✅ 详细的导入统计和日志

## 📋 前置要求

1. 确保 `memos_db/memory.json` 文件存在
2. 确保 `memos_db/memos_dev.db` 数据库文件存在
3. 已安装依赖：`npm install`

## 🚀 使用方法

### 方法一：使用 npm 脚本（推荐）

```bash
npm run import:json
```

### 方法二：直接运行脚本

```bash
node scripts/import-json-to-memos.js
```

### 方法三：使用可执行权限

```bash
./scripts/import-json-to-memos.js
```

## 📊 导入流程

脚本会执行以下步骤：

1. **检查文件** - 验证 JSON 文件和数据库文件是否存在
2. **读取数据** - 从 `memory.json` 读取备忘录数据
3. **连接数据库** - 连接到 `memos_dev.db`
4. **创建用户** - 如果不存在，创建默认用户（ID: 1）
5. **检查重复** - 对每条备忘录，检查内容是否已存在
6. **导入数据** - 导入不重复的备忘录
7. **创建标签** - 自动提取和创建标签
8. **显示统计** - 显示导入结果统计

## 📝 JSON 文件格式

`memory.json` 应该包含以下结构：

```json
{
  "memos": [
    {
      "id": 1,
      "content": "备忘录内容 #标签",
      "tags": "标签1,标签2",
      "visibility": "private",
      "pinned": false,
      "archived": false,
      "created_ts": "2025-10-04T15:42:59.844Z",
      "updated_ts": "2025-10-08T17:12:51.735Z"
    }
  ]
}
```

## 🔍 重复检测机制

脚本通过以下方式检测重复：

- 比较 `content` 字段的完整内容
- 如果数据库中已存在相同内容的备忘录，则跳过
- 显示前 5 条跳过的重复项，之后只显示总数

## 📈 输出示例

```
======================================================================
🚀 从 memory.json 导入数据到 memos_dev.db
======================================================================

📂 检查 JSON 文件...
✅ 找到文件: /path/to/memos_db/memory.json

📖 读取 JSON 数据...
✅ 读取成功，共 100 条备忘录

🗄️  检查数据库文件...
✅ 找到数据库: /path/to/memos_db/memos_dev.db

🔌 连接数据库...
✅ 连接成功

👤 检查默认用户...
✅ 创建默认用户 (ID: 1)

📊 统计数据库现有数据...
   当前数据库中有 50 条备忘录

======================================================================
📝 开始导入备忘录
======================================================================

⏳ 执行导入（使用事务优化性能）...
✅ 导入成功 (ID: 51): 第一条新备忘录内容...
✅ 导入成功 (ID: 52): 第二条新备忘录内容...
⏭️  跳过重复内容: 已存在的备忘录内容...
   已导入 100 条...

======================================================================
✨ 导入完成！
======================================================================

📊 导入统计:
   JSON 中的备忘录: 100
   成功导入: 50
   跳过重复: 50
   数据库现有总数: 100 (导入前: 50)

🎉 成功导入 50 条新备忘录到数据库！

💡 下一步:
   1. 运行 npm run dev 启动应用
   2. 访问应用查看导入的数据
   3. 或运行 node scripts/test-memos-db.js 测试数据库

✅ 数据库连接已关闭
```

## ⚙️ 数据转换

脚本会自动处理以下数据转换：

### 时间戳转换
- JSON 中的 ISO 8601 时间戳 → Unix 时间戳（秒）
- 保留原始的创建和更新时间

### 可见性转换
- `private` → `PRIVATE`
- `protected` → `PROTECTED`
- `public` → `PUBLIC`

### 状态转换
- `archived: true` → `row_status: 'ARCHIVED'`
- `archived: false` → `row_status: 'NORMAL'`

### 置顶转换
- `pinned: true` → 在 `memo_organizer` 表中创建记录
- `pinned: false` → 不创建 organizer 记录

### 标签提取
- 从 `content` 中自动提取 `#标签` 格式的标签
- 在 `tag` 表中创建标签记录
- 去重处理

## 🛡️ 安全特性

- ✅ 使用参数化查询，防止 SQL 注入
- ✅ 事务处理，确保数据一致性
- ✅ 错误处理，不会因单条数据错误而中断整个导入
- ✅ 详细日志，便于问题排查

## 🔧 故障排除

### 问题：找不到 JSON 文件
```
❌ 未找到文件: /path/to/memos_db/memory.json
```
**解决方案**：确保 `memory.json` 文件存在于 `memos_db/` 目录下

### 问题：找不到数据库文件
```
❌ 未找到数据库: /path/to/memos_db/memos_dev.db
```
**解决方案**：
1. 从 Memos 官方获取数据库文件
2. 或运行 Memos 应用创建数据库
3. 将数据库文件放到 `memos_db/` 目录下

### 问题：JSON 格式错误
```
❌ JSON 文件格式错误，找不到 memos 数组
```
**解决方案**：检查 JSON 文件格式，确保有 `memos` 数组

### 问题：所有数据都被跳过
```
⚠️  没有新数据被导入（所有内容都已存在）
```
**说明**：这是正常的，说明数据库中已经有相同内容的备忘录了

## 📚 相关脚本

- `npm run test:memos` - 测试 Memos 数据库连接
- `npm run import:memos` - 从 Memos 官方数据库导入
- `npm run migrate:to-memos` - 迁移数据到 Memos 数据库

## 💡 提示

1. **备份数据**：导入前建议备份现有数据库
2. **批量导入**：脚本使用事务，性能优秀，可处理大量数据
3. **重复运行**：可以安全地重复运行，只会导入新数据
4. **查看结果**：导入后运行 `npm run dev` 启动应用查看数据

## 🎯 最佳实践

1. **首次导入**：
   ```bash
   # 1. 备份数据库（如果有数据）
   cp memos_db/memos_dev.db memos_db/memos_dev.db.backup
   
   # 2. 执行导入
   npm run import:json
   
   # 3. 验证数据
   npm run test:memos
   ```

2. **增量导入**：
   - 直接运行 `npm run import:json`
   - 脚本会自动跳过重复内容

3. **数据清理**：
   - 如果需要重新导入，可以先清空数据库
   - 然后再运行导入脚本

## 📞 支持

如遇到问题，请：
1. 查看脚本输出的错误信息
2. 检查 JSON 文件和数据库文件是否正确
3. 参考本文档的故障排除部分

